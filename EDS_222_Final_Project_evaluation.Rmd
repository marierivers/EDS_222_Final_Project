---
title: "EDS 222 Final Project"
author: "Marie Rivers"
date: "11/13/2021"
output: 
  html_document:
    theme: flatly
    code_folding: show
    toc: TRUE
    toc_float: TRUE
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(here)
library(skimr)
library(GGally)
library(lubridate)
library(janitor)
library(kableExtra)
library(stringr)
library(ggplot2)
library(patchwork)
library(gghighlight)
library(paletteer)
library(ggExtra)
library(ggrepel)
library(ggbeeswarm)
library(sf)
library(urbnmapr)
library(tidycensus)
#library(tigris)
```

# Read in EQI data and select columns of interest
```{r}
api_txt <- "~/Documents/UCSB_Environmental_Data_Science/EDS_222_Statistics_for_Environmental_Data_Science/Final_Project_Notes/census_key.txt"

api_key <- readLines(api_txt)
census_api_key(api_key)
```

```{r}
fips_codes <- data.frame(fips_codes) %>%
  rename(county_name = county) %>%
  mutate(stfips = paste0(state_code, county_code))
```

```{r, results=FALSE, echo=FALSE, message=FALSE}
eqi <- read_csv(here("data", "eqi_data", "Eqi_results_2013JULY22.csv")) %>% 
  select(stfips, county_name, state, cat_rucc, EQI_22July2013, air_EQI_22July2013, water_EQI_22July2013, land_EQI_22July2013, built_EQI_22July2013, sociod_EQI_22July2013) %>%
  mutate(county_code = str_sub(stfips, -3)) %>% 
  mutate(rucc_text = case_when(
    cat_rucc %in% c(1, 2) ~ "metropolitan or urban",
    cat_rucc %in% c(3, 4) ~ "less urban or thinly populated")) %>%
  left_join(fips_codes, by = c("state", "county_code")) %>% 
  mutate(cat_rucc = as.factor(cat_rucc)) %>%
  select(stfips.y, state_code, county_code, state_name, state, county_name.x, county_name.y, cat_rucc, rucc_text, EQI_22July2013, air_EQI_22July2013, water_EQI_22July2013, land_EQI_22July2013, built_EQI_22July2013, sociod_EQI_22July2013) %>%
  rename(stfips = stfips.y)
```
  mutate(pop_change_text = case_when(
    pop_change_pct > 0 ~ "positive",
    pop_change_pct <= 0 ~ "negative"))
# Read in county level population data
```{r}
header <- c("county_name", "april_1_2000", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "april_1_2010", "july_1_2010")

codes <- c("01", "02", "04", "05", "06", "08", "09", "10", "11", "12", "13", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")
```

```{r, message=FALSE}
source(here("src", "state_pop_fun.R"))
county_pop = data.frame()

for (i in seq_along(codes)) {
state <- state_pop_fun(fips = codes[i])
state_df <- data.frame(state)
county_pop <- rbind(county_pop, state_df)
}
```

```{r}
county_pop <- county_pop %>% 
  left_join(fips_codes, by = c("county_name", "state_code")) %>%
  mutate(pop_change_pct = ((july_1_2010 - X2006) / X2006) * 100) %>% 
  mutate(pop_change_text = case_when(
    pop_change_pct > 0 ~ "positive",
    pop_change_pct <= 0 ~ "negative"))
```

```{r}
county_pop_histogram <- ggplot(data = county_pop, aes(x = pop_change_pct)) +
  geom_histogram(fill = "red", bins = 200)
county_pop_histogram
```

# Join eqi and population data
```{r}
eqi_pop <- left_join(eqi, county_pop, by = c("stfips")) %>% 
  #relocate(c(stfips, state_code, county_code, state, state_name), .before = county_name) %>% 
  select(-april_1_2000, -X2000, -X2001, -X2002, -X2003, -X2004, -X2005, -april_1_2010) %>%
  filter(!X2006 == "null")
```

```{r}
# xxx
write_csv(eqi_pop, here("data", "eqi_pop.csv"))
```

# Summary Statistics and Graphs
```{r}
eqi_pop_change_plot_scatter <- ggplot(data = eqi_pop, aes(x = EQI_22July2013, y = pop_change_pct)) + 
  geom_point(aes(color = pop_change_text)) +
  theme(legend.position = "bottom") +
  labs(title = "County percent population change vs. EQI, 2006-2010", x = "EQI", y = " % population change", color = "Population change:")

eqi_pop_change_plot <- ggMarginal(eqi_pop_change_plot_scatter, type = "boxplot", groupColour = TRUE)
eqi_pop_change_plot
```

```{r}
eqi_pop_rucc_scatter <- ggplot(data = eqi_pop, aes(x = EQI_22July2013, y = pop_change_pct)) + 
  geom_point(aes(color = cat_rucc), size = .75) +
  theme(legend.position = "bottom") +
  labs(title = "County percent population change vs. EQI, 2006-2010", x = "EQI", y = " % population change", color = "RUCC:")

eqi_pop_rucc_plot <- ggMarginal(eqi_pop_rucc_scatter, type = "boxplot", groupColour = TRUE)
eqi_pop_rucc_plot
```
```{r}
eqi_pop_rucc_scatter2 <- ggplot(data = eqi_pop, aes(x = EQI_22July2013, y = pop_change_pct)) + 
  geom_point(aes(color = rucc_text), size = .75) +
  theme(legend.position = "bottom") +
  labs(title = "County percent population change vs. EQI, 2006-2010", x = "EQI", y = " % population change", color = "RUCC:")

eqi_pop_rucc_plot2 <- ggMarginal(eqi_pop_rucc_scatter2, type = "boxplot", groupColour = TRUE)
eqi_pop_rucc_plot2
```

```{r}
county_pop_rucc_histogram <- ggplot(data = eqi_pop, aes(x = pop_change_pct)) +
  geom_histogram(aes(fill = cat_rucc), position = "dodge", bins = 50)
county_pop_rucc_histogram
```

```{r}
pop_boxplot <- ggplot(data = eqi_pop, aes(x = cat_rucc, y = pop_change_pct)) +
  geom_boxplot(aes(fill = cat_rucc), show.legend = FALSE) +
  coord_flip()
pop_boxplot
```
```{r}
pop_boxplot2 <- ggplot(data = eqi_pop, aes(x = pop_change_pct)) +
  geom_boxplot() +
  labs(title = "U.S. county level population change, 2006-2010", x = "percent population change") +
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())
pop_boxplot2
```


```{r}
air_eqi_pop_change_plot <- ggplot(data = eqi_pop, aes(x = air_EQI_22July2013, y = pop_change_pct)) + 
  geom_point()
```

```{r}
water_eqi_pop_change_plot <- ggplot(data = eqi_pop, aes(x = water_EQI_22July2013, y = pop_change_pct)) + 
  geom_point()
```

```{r}
land_eqi_pop_change_plot <- ggplot(data = eqi_pop, aes(x = land_EQI_22July2013, y = pop_change_pct)) + 
  geom_point()
```

```{r}
sociod_eqi_pop_change_plot <- ggplot(data = eqi_pop, aes(x = sociod_EQI_22July2013, y = pop_change_pct)) + 
  geom_point()
```

```{r}
built_eqi_pop_change_plot <- ggplot(data = eqi_pop, aes(x = built_EQI_22July2013, y = pop_change_pct)) + 
  geom_point()
```

```{r}
# all_eqi_plot <- eqi_pop_change_plot / (air_eqi_pop_change_plot + water_eqi_pop_change_plot + land_eqi_pop_change_plot + sociod_eqi_pop_change_plot + built_eqi_pop_change_plot)

all_eqi_plot <- ((eqi_pop_change_plot + plot_layout(widths = 2, heights = 2)) + (land_eqi_pop_change_plot / built_eqi_pop_change_plot) + plot_layout(widths = 1, heights = 1)) / (air_eqi_pop_change_plot + water_eqi_pop_change_plot + land_eqi_pop_change_plot + plot_layout(widths = 1, heights = 1))
all_eqi_plot
```
```{r}
p1 <- land_eqi_pop_change_plot / built_eqi_pop_change_plot
p2 <- (air_eqi_pop_change_plot | water_eqi_pop_change_plot | land_eqi_pop_change_plot) + plot_layout(widths = 1)
row1 <- (eqi_pop_change_plot | p1) + plot_layout(widths = c(2, 1))

all_eqi_plot <- (row1 / p2) + plot_layout(heights = c(3, 1))
all_eqi_plot
```
```{r}
histogram <- ggplot(data = eqi_pop, aes(x = EQI_22July2013)) +
  geom_histogram(bins = 100)
histogram
```

```{r}
histogram_pop_change <- ggplot(data = eqi_pop, aes(x = EQI_22July2013)) +
  geom_histogram(aes(fill = pop_change_text), position = "dodge", bins = 50) +
  labs(title = "Historgram of EQI based on county population change, 2006-2010", x = "EQI", fill = "Population change")
histogram_pop_change
```

# Statistical Evaluation
## Differnt means test
**null_hypothesis:** There is no difference in mean EQI for counties with positive and negative population change.
$$H_{0}: \mu_{posPopChange} - \mu_{negPopChange} = 0$$
**alternative hypothesis:** There is a difference in EQI for counties with positive and negative population change.
$$H_{A}: \mu_{posPopChange} - \mu_{negPopChange} \neq 0$$

The standard error for a difference in means is defined as: $SE = \sqrt{\frac{s_1^2}{n_1} + \frac{s^2_2}{n_2}}$ and the test-statistic for a hypothesis test is $z = \frac{\text{point estimate - null}}{SE}$

```{r}
eqi_summary_table <- eqi_pop %>%
  group_by(pop_change_text) %>%
  summarise(min_eqi = round(min(EQI_22July2013, na.rm = TRUE),2),
            max_eqi = round(max(EQI_22July2013, na.rm = TRUE),2),
            mean_eqi = round(mean(EQI_22July2013, na.rm = TRUE),2),
            sd_eqi = round(sd(EQI_22July2013, na.rm = TRUE), 2),
            var_eqi = round(var(EQI_22July2013, na.rm = TRUE), 2),
            count = n()) %>%
  bind_rows(., eqi_pop %>%
              summarise(min_eqi = round(min(EQI_22July2013, na.rm = TRUE),2),
                        max_eqi = round(max(EQI_22July2013, na.rm = TRUE),2),
                        mean_eqi = round(mean(EQI_22July2013, na.rm = TRUE),2),
                        sd_eqi = round(sd(EQI_22July2013, na.rm = TRUE), 2),
                        var_eqi = round(var(EQI_22July2013, na.rm = TRUE), 2),
                        count = n()) %>%
              mutate(pop_change_text = "all counties")
            ) %>%
  kable(col.names = c("Population Change", "Minimum", "Maximum", "Mean", "Standard Deviation", "Variance", "Number of Counties"), caption = "EQI summary statistics for counties based on population change between 2006 and 2010", color = 'black') %>%
  kable_paper(full_width = FALSE) %>%
  column_spec(1, bold = T) %>%
  row_spec(0, bold = T, color = 'black') %>%
  row_spec(3, bold = T, background = '#e5e5e5')
eqi_summary_table  
```

```{r}
# mean values
mu_eqi_pos_pop_change <- eqi_pop %>% 
  filter(pop_change_pct > 0) %>% 
  summarise(mean_eqi = mean(EQI_22July2013, na.rm = TRUE))

mu_eqi_neg_pop_change <- eqi_pop %>% 
  filter(pop_change_pct <= 0) %>% 
  summarise(mean_eqi = mean(EQI_22July2013, na.rm = TRUE))

# standard deviations  
sd_eqi_pos_pop_change <- eqi_pop %>% 
  filter(pop_change_pct > 0) %>% 
  summarise(sd_eqi = sd(EQI_22July2013, na.rm = TRUE))

sd_eqi_neg_pop_change <- eqi_pop %>% 
  filter(pop_change_pct <= 0) %>% 
  summarise(sd_eqi = sd(EQI_22July2013, na.rm = TRUE))

# count of observations 
n_pos_pop_change <- eqi_pop %>% 
  filter(pop_change_pct > 0) %>% 
  summarise(count = n())

n_neg_pop_change <- eqi_pop %>% 
  filter(pop_change_pct <= 0) %>% 
  summarise(count = n())
```
```{r}
print(sd_eqi_neg_pop_change)
```


```{r}
# calculate point estimate
point_est <- as.numeric(mu_eqi_pos_pop_change - mu_eqi_neg_pop_change)
print(point_est)
```

To calculate a standard error for a difference in means:

n = number of observations for each group
s = standard deviation for each group
$$SE = \sqrt{\frac{s_1^2}{n_1} + \frac{s^2_2}{n_2}}$$
```{r}
# calculate standard error
SE <- as.numeric(sqrt( (sd_eqi_pos_pop_change^2 / n_pos_pop_change) + (sd_eqi_neg_pop_change^2 / n_neg_pop_change) ))
```

The definition of the z-score for hypothesis testing: 

$$z_{score}=\frac{\text { point estimate }-\text { null value }}{S E}$$
```{r}
z_score <- (point_est - 0) / SE
```
Calculated p-value: the probability of getting a point estimate at least as extreme as calculates above if the null hypothesis were true: 
$$p \text { - value }=\operatorname{Pr}(Z<-|z| \text { or } Z>|z|)=2 * \operatorname{Pr}(Z>|z|)$$
```{r}
# Make use of the function `pnorm()` to access the normal distribution. Note: `pnorm()` gives you the probability mass below a certain cutoff in a probability distribution with a mean and standard deviation you can control. Use `lower.tail=FALSE` to get the mass above a given cutoff.
p_val = 2 * pnorm(point_est, mean = 0, sd = SE, lower.tail=FALSE)
print(p_val)
```

xxx...Since $p-value = 0.018 < 0.05$ we reject the null that there is no difference in the birth weight of babies born to smoking versus non-smoking mothers. We can say there is a statistically significant difference (at the 5% significance level) in baby birth weight across smoking and non-smoking mothers.

# Using `t.test()` to implement a hypothesis test in `R`

Let's repeat the above steps using the canned function in `R` that
allows you to perform hypothesis tests for comparing one or two means.

Again, we want to know if there is a statistically significant
difference in baby birth weight across smoking and non-smoking mothers.

First, take a look at `t.test()` documentation to see how the function
works.

```{r}
?t.test
```

"Performs one and two sample t-tests on vectors of data" = Performs t
tests on 1 mean and 2 means

We can implement our t-test in multiple ways using `t.test()`. First,
let's use the `formula` object, as I think this is the nicest approach.
To use this method, we first enter the variable we are interested in
evaluating means of (i.e., `weight`), then use a tilde `~` like in
regression analysis, followed by the variable indicating the groups for
which we are testing for differences in means (`habit`).

```{r}
t.test(weight ~ habit, data = ncbirths_complete_habit)
```

Note that we obtain nearly the same p-value and test-statistic (shown as
`t`) as we did above, although it's slightly different as this is using
the t-distribution and we used the normal.[^2]

[^2]: By the time $n=1000$, the t-distribution and normal are very very
    similar.



# Linear Model
Build a model for EQI vs population change and a model with coefficients for each EQI category to identify the category most correlated with population change

# Map
```{r}
county_shp <- st_read("data/gz_2010_us_050_00_20m/gz_2010_us_050_00_20m.shp")
```
project
filter only 50 states + DC
try to find a shapefile that makes alaska and hawaii look good

```{r}
# https://urbaninstitute.github.io/urbnmapr/
# counties_sf <- get_urbn_map("counties", sf = TRUE)
# 
# counties_sf %>% 
#   ggplot(aes()) +
#   geom_sf(fill = "grey", color = "#ffffff")
```

```{r}
county_map_df <- county_laea %>% 
  rename(stfips = GEOID) %>% 
  right_join(eqi_pop)
```

No space in blog post for maps!
```{r}
library(RColorBrewer)
pal <- brewer.pal(7, "OrRd")

plot(county_map_df["EQI_22July2013"],
     main = "Environmental Quality Index by County, 2006-2010",
     breaks = "quantile", 
     nbreaks = 7, 
     pal = pal)
```
```{r}
# county_map_df2 %>% 
#   ggplot(aes()) +
#   geom_sf(aes(fill = pop_change_pct), color = "black", size = .5)
```


